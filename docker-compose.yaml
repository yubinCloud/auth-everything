version: '3'
services:
  
  ##################################################################
  #################### Basic infrastructure ########################
  ##################################################################
  mysql8:
    container_name: aet-mysql8
    hostname: mysql8
    image: aet-mysql8
    expose:
      - "3306"
    # ports:
    #   - 3307:3306
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PWD}
    privileged: true
    volumes:
      - ./mysql8/volume/conf/my.cnf:/etc/mysql/my.cnf
      - ./mysql8/volume/data:/var/lib/mysql
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  xxl-job-mysql:
    container_name: ${PROJECT_PREFIX}-${XXL_JOB_MYSQL_HOST}
    hostname: ${XXL_JOB_MYSQL_HOST}
    image: aet-xxl-job-mysql
    expose:
      - ${XXL_JOB_MYSQL_PORT}
    # ports:
    #   - 3308:${XXL_JOB_MYSQL_PORT}
    environment:
      - MYSQL_ROOT_PASSWORD=${XXL_JOB_MYSQL_PWD}
    privileged: true
    volumes:
      - ./xxl-job-mysql/volume/conf/my.cnf:/etc/mysql/my.cnf
      - ./xxl-job-mysql/volume/data:/var/lib/mysql
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net

  redis6:
    container_name: ${PROJECT_PREFIX}-${REDIS_HOST}
    hostname: ${REDIS_HOST}
    image: aet-redis6
    privileged: true
    expose:
      - "6379"
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  elasticsearch7:
    image: docker.elastic.co/elasticsearch/elasticsearch-oss:7.5.1
    container_name: ${PROJECT_PREFIX}-${ES_HOST}
    hostname: ${ES_HOST}
    expose:
      - 9200
      - 9300
    volumes:
      - ./es/es_data:/usr/share/elasticsearch/data
    environment:
      - http.cors.enabled=true
      - http.cors.allow-origin=*
      - bootstrap.memory_lock=true
      - discovery.type=single-node        # 指定单节点模式
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"  # 指定内存限制
    privileged: true
    healthcheck:
      test: ["CMD-SHELL", "curl --silent --fail localhost:9200/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 800s
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  minio-server:
    image: bitnami/minio:2023.10.16
    container_name: ${PROJECT_PREFIX}-${MINIO_HOST}
    hostname: ${MINIO_HOST}
    expose:
      - 9000  # S3 API
      - 9001  # console port
    volumes:
      - ./minio-server/volume/data:/bitnami/minio/data
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD}
      - MINIO_DEFAULT_BUCKETS=simulator-img
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      start_period: 10s
      interval: 5s
      timeout: 10s
      retries: 3
    privileged: true
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
    
  euser-memcached:
    container_name: aet-euser-memcached
    hostname: euser-memcached
    image: bitnami/memcached:1.6.22
    expose:
      - 11211
    environment:
      - MEMCACHED_USERNAME=${EUSER_MEMCACHED_USERNAME}
      - MEMCACHED_PASSWORD=${EUSER_MEMCACHED_PASSWORD}
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  euser-postgresql:
    image: aet-euser-postgresql
    container_name: aet-euser-postgresql
    hostname: euser-postgresql
    environment:
      - POSTGRES_USER=${EUSER_POSTGRESQL_USER}
      - POSTGRES_PASSWORD=${EUSER_POSTGRESQL_PASSWORD}
    volumes:
      - euser-postgresql-data:/var/lib/postgresql/data
    expose:
      - 5432
    privileged: true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres | grep accepting || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 60s
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net

  af-postgresql:
    image: aet-af-postgresql
    container_name: aet-af-postgresql
    hostname: af-postgresql
    environment:
      - POSTGRES_USER=${AF_POSTGRESQL_USER}
      - POSTGRES_PASSWORD=${AF_POSTGRESQL_PASSWORD}
    volumes:
      - af-postgresql-data:/var/lib/postgresql/data
    expose:
      - 5432
    privileged: true
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres | grep accepting || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 60s
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  af-zookeeper:
    image: bitnami/zookeeper:3.9
    container_name: aet-af-zookeeper
    hostname: af-zookeeper
    volumes:
      - af-zookeeper-data:/binami/zookeeper
    expose:
      - 2181  # for client
      - 3888  # leader election
      - 2888  # cluster rpc
    environment:
      - ZOO_4LW_COMMANDS_WHITELIST=ruok
    healthcheck:
      test: "echo ruok | nc localhost 2181 | grep imok || exit 1; echo healthy"
      interval: 5s
      timeout: 7s
      retries: 3
      start_period: 30s
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  sentinel-dashboard:
    container_name: ${PROJECT_PREFIX}-${SENTINEL_HOST}
    hostname: ${SENTINEL_HOST}
    image: aet-sentinel-dashboard
    command: ["/wait-for-it.sh", "mysql8:3306", "-t", "0", "--", "sh", "-c", "java -Dauth.enabled=false -jar app.jar --server.servlet.context-path=/sentinel"]
    expose:
      - 8080
    healthcheck:
      test: ["CMD-SHELL", "curl -sS 'http://localhost:8080/sentinel/#/login' || exit 1; echo healthy"]
      interval: 5s
      timeout: 10s
      retries: 3
      start_period: 360s
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  nacos:
    container_name: ${PROJECT_PREFIX}-${NACOS_HOST}
    hostname: ${NACOS_HOST}
    image: aet-nacos
    env_file:
      - ./nacos/nacos.env
    environment:
      - MYSQL_SERVICE_HOST=${MYSQL_HOST}
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=${MYSQL_PWD}
      - MYSQL_SERVICE_DB_NAME=nacos
    expose:
      - "8848"
      - "9848"
      - "9849"
    ports:
      - 8848:8848
      # - 9848:9848
      # - 9849:9849
    healthcheck:
      test: ["CMD-SHELL", "curl -sS 'http://localhost:8848/nacos' || exit 1; echo healthy"]
      interval: 5s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      sentinel-dashboard:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  ##################################################################
  ######################### Biz Services ###########################
  ##################################################################

  gateway:
    build:
      context: ./gateway
    container_name: ${PROJECT_PREFIX}-${GATEWAY_HOST}
    hostname: ${GATEWAY_HOST}
    image: aet-gateway
    command: ["/wait-for-it.sh", "nacos:8848", "-t", "0", "--", "sh", "-c", "java -jar app.jar"]
    ports:
      - 10010:${GATEWAY_PORT}
    env_file:
      - ./.env
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:10010/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    depends_on:
      - mysql8
      - redis6
      - nacos
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  sso-auth:
    build:
      context: ./sso-auth
    container_name: ${PROJECT_PREFIX}-${AUTH_SERVICE_HOST}
    hostname: ${AUTH_SERVICE_HOST}
    image: aet-sso-auth
    expose:
      - ${AUTH_SERVICE_PORT}
    environment:
      - APP_PORT=${AUTH_SERVICE_PORT:-9590}
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILE}
      - MYSQL_DB=sso_auth  # 存放认证信息的数据库名
    env_file:
      - ./.env
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:${AUTH_SERVICE_PORT}/auth/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    depends_on:
      gateway:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net

  xxljob-admin:
    build:
      context: ./xxl-job/xxl-job-admin
    container_name: ${PROJECT_PREFIX}-${XXLJOB_ADMIN_HOST}
    hostname: ${XXLJOB_ADMIN_HOST}
    image: aet-xxljob-admin
    expose:
      - 8090
    environment:
      - PARAMS=--spring.datasource.username=root --spring.datasource.password=${XXL_JOB_MYSQL_PWD} --spring.datasource.url=jdbc:mysql://${XXL_JOB_MYSQL_HOST}:${XXL_JOB_MYSQL_PORT}/xxl_job?useUnicode=true&characterEncoding=UTF-8&autoReconnect=true&serverTimezone=GMT
    env_file:
      - ./.env
    depends_on:
      gateway:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:8090/xxl-job-admin/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  # xxljob-executor:
  #   build:
  #     context: ./xxl-job/xxl-job-executor-samples/xxl-job-executor-sample-springboot
  #   container_name: ${PROJECT_PREFIX}-${XXLJOB_EXECUTOR_HOST}
  #   hostname: ${XXLJOB_EXECUTOR_HOST}
  #   image: ${PROJECT_PREFIX}-${XXLJOB_EXECUTOR_HOST}
  #   expose:
  #     - 8081
  #     - 9999
  #   environment:
  #     - PARAMS=--xxl.job.admin.addresses=http://${XXLJOB_ADMIN_HOST}:8090/xxl-job-admin --xxl.job.executor.address=http://${XXLJOB_EXECUTOR_HOST}:9999
  #   env_file:
  #     - ./.env
  #   volumes:
  #     - miniconda:/opt/miniconda
  #     - projects_deployment:/opt/app/dadp/projects_deployment
  #   depends_on:
  #     xxljob-admin:
  #       condition: service_healthy
  #   restart: ${DOCKER_RESTART_POLICY}
  #   networks:
  #     - platform-net

  avue-nginx:
    build:
      context: ./avue-nginx
    container_name: ${PROJECT_PREFIX}-${AVUE_NGINX_HOST}
    hostname: ${AVUE_NGINX_HOST}
    image: aet-avue-nginx
    expose:
      - 8095
    volumes:
      - ./avue-data-server/exported-files:/opt/exported-files
    healthcheck:
      test: ["CMD-SHELL", "curl --fail http://localhost:8095/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    depends_on:
      gateway:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net

  avue-data-server:
    container_name: ${PROJECT_PREFIX}-${AVUE_DATA_SERVER_HOST}
    hostname: ${AVUE_DATA_SERVER_HOST}
    image: aet-avue-data-server
    expose:
      - 10002
    environment:
      - NODE_ENV=production
      - MYSQL_HOST=${MYSQL_HOST}
      - MYSQL_USER=root
      - MYSQL_PWD=${MYSQL_PWD}
      - MYSQL_PORT=3306
      - MYSQL_DB=antv_data_server
      - SIDECAR_HOST=sidecar-avue-data-server
    volumes:
      - ./avue-data-server/avue-data-server/exported-files:/src/exported-files
      - ./avue-data-server/avue-data-server/file:/src/file
    healthcheck:
      test: ["CMD-SHELL", "pm2 list | grep avue-data-server || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      gateway:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  avue-helper:
    build:
      context: ./avue-helper
    container_name: ${PROJECT_PREFIX}-${AVUE_HELPER_HOST}
    hostname: ${AVUE_HELPER_HOST}
    image: aet-avue-helper
    expose:
      - 9620
    env_file:
      - ./.env
    environment:
      - AVUE_HELPER_MINIO_HOST=http://minio-server:9000
      - AVUE_HELPER_MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - AVUE_HELPER_MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:9620/avue-helper/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 60s
    depends_on:
      avue-data-server:
        condition: service_healthy
      minio-server:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net

  ds-worker:
    build:
      context: ./ds-worker
    container_name: ${PROJECT_PREFIX}-${DS_WORKER_HOST}
    hostname: ${DS_WORKER_HOST}
    image: ${PROJECT_PREFIX}-${DS_WORKER_HOST}
    expose:
      - 9300
    env_file:
      - ./.env
    depends_on:
      avue-data-server:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  ds-coordinator:
    build:
      context: ./ds-coordinator
    container_name: ${PROJECT_PREFIX}-${DS_COORDINATOR_HOST}
    hostname: ${DS_COORDINATOR_HOST}
    image: aet-ds-coordinator
    expose:
      - 15530
    env_file:
      - ./.env
    environment:
      - ENV_FOR_DYNACONF=internal
      - TZ=Asia/Shanghai
      - SIDECAR_HOST=sidecar-ds-coordinator
      - SIDECAR_PORT=10014
    depends_on:
      gateway:
        condition: service_healthy
      elasticsearch7:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  simulator:
    build:
      context: ./simulator
    container_name: aet-simulator
    hostname: simulator
    image: aet-simulator
    expose:
      - 9660
    env_file:
      - ./.env
    environment:
      - SIDECAR_HOST=sidecar-simulator
      - SIDECAR_PORT=10017
      - FRONT_PROTOCOL=http
      - FRONT_HOST=dadp-web-unit
      - FRONT_PORT=8091
      - FRONT_IMG_MOD_PROTOCOL=http
      - FRONT_IMG_MOD_HOST=dadp-web-unit
      - FRONT_IMG_MOD_PORT=8093
      - MINIO_URL=minio-server:9000
      - MINIO_ACCESS_KEY=${MINIO_ROOT_USER}
      - MINIO_SECRET_KEY=${MINIO_ROOT_PASSWORD}
      - ENV_FOR_DYNACONF=prod
      - MERGE_ENABLED_FOR_DYNACONF=true
    depends_on:
      minio-server:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net

  euser-gateway:
    build:
      context: ./euser-gateway
    image: aet-euser-gateway
    container_name: aet-euser-gateway
    hostname: euser-gateway
    ports:
      - 13000:13000
    env_file:
      - ./.env
    environment:
      - EUSER_GATEWAY_REDIS_HOST=${REDIS_HOST}
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:13000/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 70s
    depends_on:
      euser-postgresql:
        condition: service_healthy
      redis6:
        condition: service_started
      gateway:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  euser-sso:
    build:
      context: ./euser-sso
    image: aet-euser-sso
    container_name: aet-euser-sso
    hostname: euser-sso
    expose:
      - 9592
    env_file:
      - ./.env
    environment:
      - EUSER_SSO_REDIS_HOST=${REDIS_HOST}
      - EUSER_SSO_PG_HOST=euser-postgresql
      - EUSER_SSO_PG_USER=${EUSER_POSTGRESQL_USER}
      - EUSER_SSO_PG_PASSWORD=${EUSER_POSTGRESQL_PASSWORD}
      - EUSER_SSO_MEMCACHED_HOST=euser-memcached
      - EUSER_SSO_MEMCACHED_USERNAME=${EUSER_MEMCACHED_USERNAME}
      - EUSER_SSO_MEMCACHED_PASSWORD=${EUSER_MEMCACHED_PASSWORD}
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:9592/euser-sso/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 70s
    depends_on:
      euser-postgresql:
        condition: service_healthy
      redis6:
        condition: service_started
      euser-memcached:
        condition: service_started
      gateway:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net


  ##################################################################
  #################### Alibaba Sidecars ############################
  ##################################################################
  sidecar-jupyter-service:
    build:
      context: ./alibaba-sidecars/jupyter-service
    container_name: ${PROJECT_PREFIX}-${SIDECAR_JUPYTER_SERVICE_HOST}
    hostname: ${SIDECAR_JUPYTER_SERVICE_HOST}
    image: aet-sidecar-jupyter-service
    expose:
      - ${SIDECAR_JUPYTER_SERVICE_PORT}
    env_file:
      - ./.env
    environment:
      - APP_PORT=${SIDECAR_JUPYTER_SERVICE_PORT}
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:10011/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    depends_on:
      gateway:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net

  sidecar-avue-data-server:
    build:
      context: ./alibaba-sidecars/avue-data-server
    container_name: ${PROJECT_PREFIX}-${SIDECAR_AVUE_DATA_SERVER_HOST}
    hostname: ${SIDECAR_AVUE_DATA_SERVER_HOST}
    image: ${PROJECT_PREFIX}-${SIDECAR_AVUE_DATA_SERVER_HOST}
    expose:
      - ${SIDECAR_AVUE_DATA_SERVER_PORT}
    env_file:
      - ./.env
    environment:
      - APP_PORT=${SIDECAR_AVUE_DATA_SERVER_PORT}
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:10012/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    depends_on:
      - avue-data-server
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  sidecar-avue-nginx:
    build:
      context: ./alibaba-sidecars/avue-nginx
    container_name: ${PROJECT_PREFIX}-${SIDECAR_AVUE_NGINX_HOST}
    hostname: ${SIDECAR_AVUE_NGINX_HOST}
    image: ${PROJECT_PREFIX}-${SIDECAR_AVUE_NGINX_HOST}
    expose:
      - ${SIDECAR_AVUE_NGINX_PORT}
    env_file:
      - ./.env
    environment:
      - APP_PORT=${SIDECAR_AVUE_NGINX_PORT}
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:10013/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    depends_on:
      avue-nginx:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
    
  sidecar-ds-coordinator:
    build:
      context: ./alibaba-sidecars/nacos-sidecar
    container_name: aet-sidecar-ds-coordinator
    hostname: sidecar-ds-coordinator
    image: aet-nacos-sidecar
    expose:
      - 10014
    env_file:
      - ./.env
    environment:
      - APP_PORT=10014
      - APP_NAME=ds-coordinator
      - SERVICE_IP=ds-coordinator
      - SERVICE_PORT=15530
      - SERVICE_HEALTH_CHECK_URL=http://ds-coordinator:15530/health
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:10014/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    depends_on:
      gateway:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
    
  sidecar-simulator:
    build:
      context: ./alibaba-sidecars/nacos-sidecar
    container_name: aet-sidecar-simulator
    hostname: sidecar-simulator
    image: aet-nacos-sidecar
    expose:
      - 10017
    env_file:
      - ./.env
    environment:
      - APP_PORT=10017
      - APP_NAME=simulator
      - SERVICE_IP=simulator
      - SERVICE_PORT=9660
      - SERVICE_HEALTH_CHECK_URL=http://simulator:9660/health
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:10017/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    depends_on:
      gateway:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net
  
  sidecar-genreports:
    build:
      context: ./alibaba-sidecars/nacos-sidecar
    container_name: aet-sidecar-genreports
    hostname: sidecar-genreports
    image: aet-nacos-sidecar
    expose:
      - 10018
    env_file:
      - ./.env
    environment:
      - APP_PORT=10018
      - APP_NAME=genreports
      - SERVICE_IP=genreports
      - SERVICE_PORT=8110
      - SERVICE_HEALTH_CHECK_URL=http://genreports:8110/health
    healthcheck:
      test: ["CMD-SHELL", "curl -f localhost:10018/actuator/health | grep UP || exit 1; echo healthy"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 300s
    depends_on:
      gateway:
        condition: service_healthy
    restart: ${DOCKER_RESTART_POLICY}
    networks:
      - platform-net

networks:
  platform-net:
    external: true

volumes:
  euser-postgresql-data:
    external: true
    name: aet-euser-postgresql-data